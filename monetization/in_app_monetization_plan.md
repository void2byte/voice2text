# План реализации монетизации в приложении Screph

## Цели

1.  Интегрировать систему монетизации в существующее приложение Screph.
2.  Позволить пользователям видеть свой баланс минут.
3.  Ограничивать использование функций на основе доступных минут.
4.  Предоставить пользователям возможность покупать пакеты минут (через внешний веб-интерфейс, на который будет ссылка).

## Компоненты

### 1. Интеграция с бэкендом (Backend Integration)

*   **Директория:** `monetization/in_app_monetization/backend_integration/`
*   **Задачи:**
    *   [x] `api_client.py`: Клиент для взаимодействия с API бэкенда монетизации.
        *   [x] Получение текущего баланса пользователя (минуты, срок действия).
        *   [x] Отправка информации об использованных ресурсах (минутах).
        *   [ ] (Опционально) Получение списка доступных пакетов минут для покупки.
        *   [ ] (Опционально) Инициация процесса покупки (редирект на страницу оплаты).
    *   [x] `__init__.py`: Сделать директорию пакетом.

### 2. Ядро монетизации (Core Logic)

*   **Директория:** `monetization/in_app_monetization/core/`
*   **Задачи:**
    *   [x] `monetization_service.py`: Сервис, управляющий логикой монетизации.
        *   [x] Хранение и обновление текущего баланса пользователя (с использованием `ApiClient`).
        *   [x] Метод для проверки, достаточно ли минут для выполнения определенной операции (`has_sufficient_minutes(feature_cost)`).
        *   [x] Метод для списания минут после использования функции (`consume_minutes(feature_cost)`).
        *   [ ] Обработка ошибок связи с бэкендом (например, временное кэширование баланса).
    *   [x] `__init__.py`: Сделать директорию пакетом.

### 3. Интеграция с UI (UI Integration)

*   **Директория:** `monetization/in_app_monetization/ui/`
*   **Задачи:** (Реализация будет зависеть от UI-фреймворка Screph - PyQt, Tkinter, Web и т.д. Пока что создаются заглушки)
    *   [x] `ui_integration.py`: Функции для отображения информации в UI.
        *   [x] Отображение текущего баланса минут в соответствующем месте UI.
        *   [x] Уведомления пользователю о низком балансе.
        *   [x] Сообщения об ошибке, если минут недостаточно для использования функции.
        *   [x] Кнопка/ссылка "Купить минуты", ведущая на веб-страницу покупки (например, на страницу профиля пользователя на бэкенде).
        *   [ ] Виджет/секция в главном окне или системном трее для постоянного отображения баланса пользователя.
        *   [ ] (Опционально) Отображение истории покупок/списаний (если API бэкенда это поддерживает).
    *   [x] `__init__.py`: Сделать директорию пакетом.

### 4. Конфигурация

*   **Директория:** `monetization/in_app_monetization/`
*   **Задачи:**
    *   [x] `config.py`: Конфигурационные параметры.
        *   [x] URL бэкенда API.
        *   [x] Пороги для уведомлений (например, порог низкого баланса).
        *   [ ] Другие настройки (например, частота обновления баланса).

### 5. Обвязка и инициализация

*   **Директория:** `monetization/in_app_monetization/`
*   **Задачи:**
    *   [x] `__init__.py`: Сделать `in_app_monetization` пакетом.
    *   [ ] Механизм инициализации `MonetizationService` при старте приложения Screph (или при логине пользователя).
    *   [ ] Получение токена аутентификации пользователя Screph для использования в `ApiClient`.

### 6. Интеграция в существующий код Screph

*   **Директория для изменений в ядре:** `monetization/in_app_monetization/core_logic_changes/`
    *   [x] `README.md`: Описание назначения директории.
    *   [x] `__init__.py`: Сделать директорию пакетом.
### 3.2. Модификации GUI (`gui_modifications`)

- [x] Создать директорию `gui_modifications`.
- [x] Создать `gui_modifications/__init__.py`.
- [x] Создать `gui_modifications/README.md`.
- [x] Реализовать `balance_widget.py` для отображения баланса пользователя (PyQt).
- [x] Реализовать `monetization_dialogs.py` для диалогов о низком/отсутствующем балансе (PyQt).
- [x] Реализовать `gui_utils.py` для вспомогательных функций GUI, связанных с монетизацией (например, открытие окна покупки).
*   **Директория для обработки офлайн-режима:** `monetization/in_app_monetization/offline_handling/`
    *   [x] `README.md`: Описание назначения директории.
    *   [x] `__init__.py`: Сделать директорию пакетом.
*   **Задачи (вне данного модуля, но являются целью):**
    *   [ ] **Точки проверки баланса:** В коде Screph, перед выполнением платных функций, добавить вызовы `MonetizationService.has_sufficient_minutes()`.
    *   [ ] **Точки списания минут:** После успешного выполнения платной функции, добавить вызовы `MonetizationService.consume_minutes()`.
    *   [ ] **Отображение UI элементов:** Интегрировать вызовы из `ui_integration.py` в соответствующие части UI Screph (например, интеграция виджета баланса в `gui.main_window`, отображение уведомлений).
    *   [ ] **Обработка отсутствия минут:** Реализовать логику поведения приложения, когда у пользователя недостаточно минут (блокировка функции, предложение купить минуты через `ui_integration`).
    *   [ ] **Примеры модулей для интеграции:** `bot_logic`, `voice_control`, модули, отвечающие за выполнение ресурсоемких или уникальных операций.

## Следующие шаги (после создания базовых файлов)

1.  **Интеграция с системой аутентификации Screph:**
    *   Определить, как `MonetizationService` будет получать токен текущего пользователя Screph.
    *   Передавать этот токен в `MonetizationApiClient`.
2.  **Инициализация сервиса:**
    *   Решить, где и когда будет создаваться экземпляр `MonetizationService` (например, при логине пользователя).
    *   Обеспечить доступ к этому экземпляру из тех частей приложения, где он нужен.
3.  **Реальная интеграция с UI Screph:**
    *   Заменить заглушки в `ui_integration.py` на реальные вызовы функций UI-фреймворка, используемого в Screph (например, PyQt).
    *   Разработать и интегрировать виджет отображения баланса (например, в `gui.main_window` или аналогичном месте) и диалоговые окна для уведомлений и ошибок, связанных с монетизацией.
    *   Разместить элементы отображения баланса и кнопки покупки в интерфейсе.
4.  **Внедрение проверок и списаний в код Screph:**
    *   Провести ревизию кода Screph (например, в `bot_logic`, `voice_control`, `image_processing`) для выявления всех платных функций.
    *   Определить список функций Screph, которые должны тарифицироваться.
    *   Для каждой такой функции:
        *   Определить "стоимость" в минутах.
        *   Перед выполнением функции вызывать `monetization_service.has_sufficient_minutes(cost)`.
        *   Если минут недостаточно, показать пользователю сообщение (через `ui_integration`) и не выполнять функцию.
        *   После успешного выполнения функции вызывать `monetization_service.consume_minutes(cost)`.
5.  **Тестирование:**
    *   Модульное тестирование `ApiClient` и `MonetizationService` (с моками для API и UI).
    *   Интеграционное тестирование всего флоу: от отображения баланса до списания минут после использования функции.
    *   Тестирование сценариев с недостаточным балансом, ошибками API.
6.  **Обработка ошибок и граничных случаев:**
    *   Что делать, если бэкенд недоступен при попытке проверить баланс или списать минуты? (Кэширование, повторные попытки, уведомление пользователя).
    *   Как обрабатывать ситуацию, если токен пользователя недействителен?
7.  **Документация:**
    *   Описать, как модуль монетизации интегрируется и используется в Screph.

## Открытые вопросы и предположения

1.  **Система аутентификации**: Предполагается, что в Screph уже есть система аутентификации пользователей (например, через Telegram ID).
2.  **UI фреймворк**: Предполагается использование определенного UI фреймворка (например, tkinter, PyQt, или веб-интерфейс).
3.  **API бэкенда**: Предполагается, что бэкенд монетизации предоставляет REST API для взаимодействия.
4.  **Обработка ошибок**: Необходимо определить стратегию обработки ошибок сети и API.
5.  **Кэширование**: Возможно, потребуется кэширование данных о балансе для улучшения производительности.
6.  **Безопасность**: Необходимо обеспечить безопасную передачу данных между клиентом и сервером.

## Анализ соответствия текущей реализации плану

### ✅ Реализованные компоненты:

1. **Структура модуля** - полностью соответствует плану:
   - `core/` - ядро монетизации с `MonetizationService`
   - `api/` - клиент для взаимодействия с бэкендом
   - `ui/` - интеграция с пользовательским интерфейсом
   - `gui_modifications/` - компоненты GUI для монетизации

2. **Ядро монетизации** (`MonetizationService`):
   - ✅ Проверка баланса пользователя
   - ✅ Списание минут с валидацией
   - ✅ Получение информации об активных пакетах
   - ✅ Принудительное обновление баланса
   - ✅ Кэширование баланса для производительности

3. **API клиент** (`MonetizationAPIClient`):
   - ✅ Получение баланса пользователя
   - ✅ Отправка информации об использованных минутах
   - ✅ Базовая обработка HTTP ошибок

4. **GUI компоненты**:
   - ✅ `BalanceWidget` для отображения баланса
   - ✅ `LowBalanceDialog` для предупреждений
   - ✅ `NoMinutesDialog` для блокировки функций

### ⚠️ Частично реализованные компоненты:

1. **UI интеграция** (`ui_integration.py`):
   - ✅ Базовая структура функций реализована
   - ⚠️ **ТРЕБУЕТ ДОРАБОТКИ**: Все функции являются заглушками с логированием
   - ⚠️ Отсутствует реальная интеграция с UI фреймворком Screph
   - ⚠️ Нет привязки к конкретным UI элементам приложения

2. **GUI утилиты** (`gui_utils.py`):
   - ⚠️ **ТРЕБУЕТ ДОРАБОТКИ**: `find_main_window()` - заглушка
   - ⚠️ **ТРЕБУЕТ ДОРАБОТКИ**: `show_monetization_view()` - заглушка
   - ⚠️ Отсутствует реальная логика поиска и взаимодействия с главным окном

### 🔴 Отсутствующие компоненты:

1. **Интеграция с основным приложением**:
   - 🔴 Отсутствует интеграция с главным модулем Screph
   - 🔴 Нет точек входа для проверки баланса перед выполнением функций
   - 🔴 Отсутствует автоматическое списание минут при использовании функций

2. **Конфигурация и настройки**:
   - 🔴 Отсутствует файл конфигурации для настройки URL бэкенда
   - 🔴 Нет настроек для различных сред (dev/prod)
   - 🔴 Отсутствуют настройки таймаутов и retry логики

3. **Обработка ошибок**:
   - 🔴 Недостаточная обработка сетевых ошибок
   - 🔴 Отсутствует fallback логика при недоступности бэкенда
   - 🔴 Нет пользовательских уведомлений об ошибках

4. **Тестирование**:
   - 🔴 Отсутствуют unit тесты для всех компонентов
   - 🔴 Нет integration тестов с mock бэкендом
   - 🔴 Отсутствуют тесты UI компонентов

5. **Документация**:
   - 🔴 Отсутствует документация по интеграции с Screph
   - 🔴 Нет примеров использования API
   - 🔴 Отсутствует руководство по настройке

### 📋 Критические задачи для завершения интеграции:

1. **Высокий приоритет**:
   - **Реализовать реальную UI интеграцию** вместо заглушек
   - **Определить UI фреймворк Screph** и адаптировать компоненты
   - **Добавить точки интеграции** в основные функции Screph
   - **Реализовать автоматическое списание минут** при использовании функций

2. **Средний приоритет**:
   - **Добавить конфигурационный файл** с настройками бэкенда
   - **Улучшить обработку ошибок** и добавить fallback логику
   - **Реализовать GUI утилиты** для поиска и взаимодействия с главным окном
   - **Добавить пользовательские уведомления** об ошибках

3. **Низкий приоритет**:
   - **Написать unit и integration тесты**
   - **Создать документацию** по интеграции
   - **Добавить метрики** использования функций

### 🎯 Следующие шаги:

1. **Исследовать архитектуру Screph**:
   - Определить используемый UI фреймворк
   - Найти точки входа для основных функций
   - Изучить систему аутентификации

2. **Реализовать реальную интеграцию**:
   - Заменить заглушки в `ui_integration.py` на реальный код
   - Интегрировать `MonetizationService` в основные функции Screph
   - Добавить проверки баланса перед выполнением операций

3. **Тестирование и отладка**:
   - Протестировать интеграцию с mock данными
   - Проверить корректность списания минут
   - Убедиться в правильности отображения UI элементов