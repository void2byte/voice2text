# План реализации бэкенда для системы монетизации

## 1. Определение требований и архитектуры

-   **1.1. Анализ требований:**
    -   Определить ключевые функции бэкенда: управление пользователями, пакетами минут, балансом минут, обработка платежей, API для взаимодействия с приложением Screph и Telegram-ботом.
    -   Требования к производительности, масштабируемости и безопасности.
-   **1.2. Выбор технологического стека:**
    -   Язык программирования (например, Python, Node.js, Go).
    -   Фреймворк (например, FastAPI, Django, Flask для Python; Express.js для Node.js).
    -   База данных (например, PostgreSQL, MySQL, MongoDB) для хранения информации о пользователях, пакетах минут, балансе минут, транзакциях.
    -   Система очередей (например, RabbitMQ, Redis) для асинхронных задач (например, обработка уведомлений от платежных систем).
-   **1.3. Проектирование архитектуры:**
    -   Микросервисная или монолитная архитектура.
    -   Схема базы данных.
    -   Определение API эндпоинтов и форматов данных (RESTful API, GraphQL).

## 2. Разработка основных модулей

-   **2.1. Модуль управления пользователями (User Management):**
    -   Регистрация, аутентификация, авторизация пользователей.
        -   Модели (например, `User` с полями для Telegram ID, email, etc.) будут определены в `monetization/backend/user_management/models.py`.
        -   Логика регистрации, аутентификации (например, с использованием Django Allauth или кастомная) и управления профилями будет реализована в `monetization/backend/user_management/views.py` и, возможно, вынесена в сервисный слой `monetization/backend/user_management/services.py`.
        -   URL-маршруты для этих операций будут определены в `monetization/backend/user_management/urls.py` (например, `/auth/register/`, `/auth/login/`, `/profile/`).
        -   Для API взаимодействия (если используется Django REST Framework) сериализаторы данных пользователя будут находиться в `monetization/backend/user_management/serializers.py`.
    -   Управление профилями пользователей.
    -   Связь с Telegram ID пользователя.
-   **2.2. Модуль управления пакетами и балансом минут (Minute Package Management):**
    -   Создание, редактирование, удаление пакетов минут.
        -   Модели для пакетов минут (например, `MinutePackage` с полями: название, количество минут, стоимость, срок действия в днях) и для отслеживания баланса пользователя (например, `UserMinuteBalance` с связью ForeignKey к `User` и `MinutePackage`, дата покупки, дата истечения, оставшиеся минуты) будут определены в `monetization/backend/minute_package_management/models.py`.
        -   Логика для CRUD операций с пакетами минут (для администратора), покупки пакетов пользователем, расчета и обновления баланса, а также списания минут будет реализована в `monetization/backend/minute_package_management/views.py` и/или вынесена в `monetization/backend/minute_package_management/services.py`.
        -   URL-маршруты (например, `/packages/` для списка пакетов, `/packages/<id>/buy/` для покупки, `/balance/` для проверки баланса) будут в `monetization/backend/minute_package_management/urls.py`.
        -   Сериализаторы для API (DRF) будут в `monetization/backend/minute_package_management/serializers.py`.
    -   Обработка покупки пакета минут пользователем.
    -   Отслеживание баланса минут пользователя, включая сроки действия каждого купленного пакета.
    -   Управление использованием минут для облачных сервисов распознавания (списание с баланса).
    -   **Анализ стоимости облачных сервисов (для справки при формировании стоимости пакетов минут, на момент последнего обновления информации):**
        -   **Yandex SpeechKit (синхронное распознавание, API v2/v3):**
            -   Тарификация: по 15-секундным блокам аудио. Меньшие отрезки округляются до 15 секунд. <mcreference link="https://cloud.yandex.com/en/docs/speechkit/pricing" index="1">1</mcreference> <mcreference link="https://cloud.yandex.ru/docs/speechkit/pricing" index="2">2</mcreference>
            -   Примерная стоимость (может меняться, требует уточнения на официальном сайте Yandex Cloud):
                -   Цена за 15 секунд: ~0.0044 USD (примерно, исходя из цен для РФ, может отличаться для других регионов и валют). <mcreference link="https://cloud.yandex.com/en/docs/speechkit/pricing" index="1">1</mcreference>
                -   **Расчет стоимости:**
                    -   **В секунду:** ~0.0044 USD / 15 сек = ~0.000293 USD/сек
                    -   **В минуту:** ~0.000293 USD/сек * 60 сек = ~0.0176 USD/мин
                    -   **В час:** ~0.0176 USD/мин * 60 мин = ~1.056 USD/час
        -   **Google Cloud Speech-to-Text (Standard models):**
            -   Тарификация: первые 0-60 минут в месяц бесплатно (может меняться). <mcreference link="https://cloud.google.com/speech-to-text/pricing" index="4">4</mcreference>
            -   Далее: ~0.006 USD за каждые 15 секунд (для стандартных моделей, другие модели могут иметь другую цену). <mcreference link="https://cloud.google.com/speech-to-text/pricing" index="4">4</mcreference>
            -   **Расчет стоимости (после исчерпания бесплатного лимита):**
                -   **За 15 секунд:** 0.006 USD <mcreference link="https://cloud.google.com/speech-to-text/pricing" index="4">4</mcreference>
                -   **В секунду:** 0.006 USD / 15 сек = 0.0004 USD/сек
                -   **В минуту:** 0.0004 USD/сек * 60 сек = 0.024 USD/мин
                -   **В час:** 0.024 USD/мин * 60 мин = 1.44 USD/час
        -   *Примечание: Цены являются ориентировочными и могут изменяться. Необходимо всегда проверять актуальные тарифы на официальных сайтах провайдеров. Также могут существовать различные модели тарификации (например, для потокового распознавания, асинхронного, использования специфичных моделей и т.д.), которые здесь не учтены.*
-   **2.3. Модуль интеграции с платежными системами (Payment Gateway Integration):**
    -   Выбор и интеграция с платежными шлюзами.
        -   Логика для инициации платежей (например, генерация платежной ссылки/формы) и обработки вебхуков от платежных систем будет находиться в `monetization/backend/payment_gateway_integration/views.py` и/или `monetization/backend/payment_gateway_integration/services.py`.
        -   Модели для логирования транзакций (например, `PaymentTransaction` с полями: пользователь, пакет, сумма, статус, ID транзакции в платежной системе, временные метки) будут в `monetization/backend/payment_gateway_integration/models.py`.
        -   URL-маршруты для вебхуков (например, `/payments/webhook/yookassa/`) и, возможно, для перенаправления на страницу оплаты будут в `monetization/backend/payment_gateway_integration/urls.py`.
        -   После успешной обработки вебхука, сервис из `payment_gateway_integration` будет вызывать сервис из `minute_package_management` для начисления минут пользователю.
-   **2.4. API для взаимодействия (агрегируется в `monetization/backend/api/`):**
    -   Основные эндпоинты API будут определены в `monetization/backend/api/urls.py` и реализованы в `monetization/backend/api/views.py`. Эти `views` будут выступать в роли фасадов, вызывая соответствующую бизнес-логику (сервисы или `views`) из модулей `user_management`, `minute_package_management` и `payment_gateway_integration`.
    -   **Для Telegram-бота:**
        -   `GET /api/packages/` - получение списка доступных пакетов минут (из `minute_package_management.views.PackageListView`).
        -   `POST /api/orders/` - создание заказа на покупку пакета (через `payment_gateway_integration.views.CreatePaymentView`, который затем вызовет `minute_package_management.services.create_pending_order`).
        -   `GET /api/users/me/balance/` - проверка баланса минут (из `minute_package_management.views.UserBalanceView`).
    -   **Для приложения Screph:**
        -   `GET /api/users/me/balance/` - проверка баланса минут пользователя.
        -   `POST /api/usage/record/` - списание использованных минут (вызовет `minute_package_management.services.deduct_minutes`).
    -   Все API эндпоинты будут использовать сериализаторы из соответствующих модулей (например, `monetization/backend/api/serializers.py` может агрегировать или ссылаться на сериализаторы других модулей, либо каждый модуль предоставляет свои сериализаторы для API).

## 3. Безопасность и администрирование

-   **3.1. Безопасность:**
    -   Защита API (аутентификация, авторизация, ограничение частоты запросов).
    -   Шифрование чувствительных данных.
    -   Защита от распространенных веб-уязвимостей (XSS, CSRF, SQL-инъекции).
-   **3.2. Админ-панель (Django Admin):**
    -   Модели из всех ключевых модулей будут зарегистрированы для управления через стандартную админ-панель Django.
        -   `monetization/backend/user_management/admin.py`: регистрация модели `User`.
        -   `monetization/backend/minute_package_management/admin.py`: регистрация моделей `MinutePackage`, `UserMinuteBalance`.
        -   `monetization/backend/payment_gateway_integration/admin.py`: регистрация модели `PaymentTransaction`.
    -   Доступ к админ-панели будет осуществляться через стандартный URL Django (например, `/admin/`). Директория `monetization/backend/admin_panel/` не будет содержать отдельного Django-приложения, а скорее конфигурационные файлы или статику, если потребуется кастомизация админки.

## 4. Тестирование и развертывание

-   **4.1. Тестирование:**
    -   Модульное тестирование (Unit tests).
    -   Интеграционное тестирование (Integration tests) взаимодействия модулей и с внешними системами (платежные шлюзы).
    -   Тестирование API.
-   **4.2. Развертывание (Deployment):**
    -   Выбор хостинг-провайдера или настройка собственного сервера.
    -   Настройка CI/CD (Continuous Integration / Continuous Deployment) для автоматизации сборки и развертывания.
    -   Мониторинг и логирование работы бэкенда.

## 5. Документация

-   **5.1. API документация:**
    -   Подробное описание всех API эндпоинтов, форматов запросов и ответов (например, с использованием Swagger/OpenAPI).
-   **5.2. Внутренняя документация:**
    -   Описание архитектуры, модулей, процессов.

## Дорожная карта (Примерная)

-   **Фаза 1: MVP (Minimum Viable Product)**
    -   Базовое управление пользователями (регистрация через Telegram ID).
    -   Управление пакетами минут (создание админом).
    -   Интеграция с одной платежной системой.
    -   Покупка и отслеживание баланса минут (включая сроки действия).
    -   API для проверки баланса минут и их списания.
-   **Фаза 2: Расширение функционала**
    -   Более гибкое управление пакетами минут (например, акции, скидки).
    -   Поддержка нескольких платежных систем.
    -   Уведомления пользователям (например, о скором сгорании минут, об исчерпании баланса).
    -   Базовая админ-панель.
-   **Фаза 3: Оптимизация и масштабирование**
    -   Оптимизация производительности.
    -   Улучшение безопасности.
    -   Подготовка к масштабированию.

## Анализ соответствия текущей реализации плану

### ✅ Реализованные компоненты:

1. **Модели данных** - полностью реализованы:
   - `User` с поддержкой `telegram_id`
   - `MinutePackage` для описания пакетов минут
   - `UserPackage` для отслеживания приобретенных пакетов
   - `PaymentTransaction` для записи транзакций

2. **API эндпоинты** - базовая функциональность реализована:
   - Регистрация и управление профилем пользователя
   - Просмотр доступных пакетов минут
   - Получение баланса пользователя с активными пакетами
   - Списание минут через API
   - Инициация платежей (заглушка)

3. **Сериализаторы** - реализованы для всех основных моделей

### ⚠️ Требуют доработки:

1. **Интеграция с платежными системами** (`payment_gateway_integration/views.py`):
   - **КРИТИЧНО**: Заглушки для YooKassa и Stripe требуют реальной реализации
   - Необходимо добавить реальную обработку webhook-уведомлений
   - Требуется реализация автоматического начисления минут после успешной оплаты

2. **Обработка webhook-уведомлений**:
   - `PaymentWebhookView` содержит только заглушку
   - Необходимо добавить валидацию подписи webhook-запросов
   - Требуется реализация логики обновления статуса транзакции и начисления минут

3. **Безопасность API**:
   - Отсутствует аутентификация для большинства эндпоинтов
   - Необходимо добавить проверку прав доступа
   - Требуется реализация rate limiting

4. **Обработка ошибок**:
   - Недостаточная обработка граничных случаев
   - Отсутствует логирование критических операций
   - Необходимо улучшить сообщения об ошибках для клиентов

### 🔴 Отсутствующие компоненты:

1. **Система уведомлений**:
   - Отсутствует уведомление пользователей о скором истечении пакетов
   - Нет системы email/push уведомлений

2. **Админ-панель**:
   - Базовая Django admin настроена, но требует кастомизации
   - Отсутствуют специализированные представления для управления транзакциями

3. **Мониторинг и логирование**:
   - Отсутствует централизованное логирование
   - Нет метрик для мониторинга системы

4. **Тестирование**:
   - Отсутствуют unit и integration тесты
   - Нет тестов для API эндпоинтов

### 📋 Приоритетные задачи для завершения MVP:

1. **Высокий приоритет**:
   - Реализовать интеграцию с реальными платежными системами
   - Добавить обработку webhook-уведомлений
   - Реализовать аутентификацию API
   - Добавить автоматическое начисление минут после оплаты

2. **Средний приоритет**:
   - Улучшить обработку ошибок и логирование
   - Добавить валидацию данных
   - Реализовать rate limiting

3. **Низкий приоритет**:
   - Добавить систему уведомлений
   - Улучшить админ-панель
   - Написать тесты